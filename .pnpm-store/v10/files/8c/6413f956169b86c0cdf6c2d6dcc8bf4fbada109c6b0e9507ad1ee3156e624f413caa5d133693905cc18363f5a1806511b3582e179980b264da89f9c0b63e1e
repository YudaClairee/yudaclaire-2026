{"version":3,"file":"trace.js","sources":["../../../src/import-protection-plugin/trace.ts"],"sourcesContent":["import { getOrCreate, relativizePath } from './utils'\n\nexport interface TraceEdge {\n  importer: string\n  specifier?: string\n}\n\n/**\n * Per-environment reverse import graph.\n * Maps a resolved module id to the set of modules that import it.\n */\nexport class ImportGraph {\n  /**\n   * resolvedId -> Map<importer, specifier>\n   *\n   * We use a Map instead of a Set of objects so edges dedupe correctly.\n   */\n  readonly reverseEdges: Map<string, Map<string, string | undefined>> =\n    new Map()\n\n  /**\n   * Forward-edge index: importer -> Set<resolvedId>.\n   *\n   * Maintained alongside reverseEdges so that {@link invalidate} can remove\n   * all outgoing edges for a file in O(outgoing-edges) instead of scanning\n   * every reverse-edge map in the graph.\n   */\n  private readonly forwardEdges: Map<string, Set<string>> = new Map()\n\n  readonly entries: Set<string> = new Set()\n\n  addEdge(resolved: string, importer: string, specifier?: string): void {\n    getOrCreate(this.reverseEdges, resolved, () => new Map()).set(\n      importer,\n      specifier,\n    )\n    getOrCreate(this.forwardEdges, importer, () => new Set()).add(resolved)\n  }\n\n  /** Convenience for tests/debugging. */\n  getEdges(resolved: string): Set<TraceEdge> | undefined {\n    const importers = this.reverseEdges.get(resolved)\n    if (!importers) return undefined\n    const out = new Set<TraceEdge>()\n    for (const [importer, specifier] of importers) {\n      out.add({ importer, specifier })\n    }\n    return out\n  }\n\n  addEntry(id: string): void {\n    this.entries.add(id)\n  }\n\n  clear(): void {\n    this.reverseEdges.clear()\n    this.forwardEdges.clear()\n    this.entries.clear()\n  }\n\n  invalidate(id: string): void {\n    // Remove all outgoing edges (id as importer) using the forward index.\n    const targets = this.forwardEdges.get(id)\n    if (targets) {\n      for (const resolved of targets) {\n        this.reverseEdges.get(resolved)?.delete(id)\n      }\n      this.forwardEdges.delete(id)\n    }\n    // Remove as a target (id as resolved module)\n    this.reverseEdges.delete(id)\n  }\n}\n\nexport interface TraceStep {\n  file: string\n  specifier?: string\n  line?: number\n  column?: number\n}\n\nexport interface Loc {\n  file?: string\n  line: number\n  column: number\n}\n\n/**\n * BFS from a node upward through reverse edges to find the shortest\n * path to an entry module.\n */\nexport function buildTrace(\n  graph: ImportGraph,\n  startNode: string,\n  maxDepth: number = 20,\n): Array<TraceStep> {\n  // BFS upward (startNode -> importers -> ...)\n  const visited = new Set<string>([startNode])\n  const depthByNode = new Map<string, number>([[startNode, 0]])\n\n  // For any importer we visit, store the \"down\" link back toward startNode.\n  // importer --(specifier)--> next\n  const down = new Map<string, { next: string; specifier?: string }>()\n\n  const queue: Array<string> = [startNode]\n  let qi = 0\n\n  let root: string | null = null\n\n  while (qi < queue.length) {\n    const node = queue[qi++]!\n    const depth = depthByNode.get(node)!\n    const importers = graph.reverseEdges.get(node)\n\n    if (node !== startNode) {\n      const isEntry =\n        graph.entries.has(node) || !importers || importers.size === 0\n      if (isEntry) {\n        root = node\n        break\n      }\n    }\n\n    if (depth >= maxDepth) {\n      continue\n    }\n\n    if (!importers || importers.size === 0) {\n      continue\n    }\n\n    for (const [importer, specifier] of importers) {\n      if (visited.has(importer)) continue\n      visited.add(importer)\n      depthByNode.set(importer, depth + 1)\n      down.set(importer, { next: node, specifier })\n      queue.push(importer)\n    }\n  }\n\n  // Best-effort: if we never found a root, just start from the original node.\n  if (!root) {\n    root = startNode\n  }\n\n  const trace: Array<TraceStep> = []\n  let current = root\n  for (let i = 0; i <= maxDepth + 1; i++) {\n    const link = down.get(current)\n    trace.push({ file: current, specifier: link?.specifier })\n    if (!link) break\n    current = link.next\n  }\n\n  return trace\n}\n\nexport interface ViolationInfo {\n  env: string\n  envType: 'client' | 'server'\n  type: 'specifier' | 'file' | 'marker'\n  behavior: 'error' | 'mock'\n  pattern?: string | RegExp\n  specifier: string\n  importer: string\n  importerLoc?: Loc\n  resolved?: string\n  trace: Array<TraceStep>\n  message: string\n  /** Vitest-style code snippet showing the offending usage in the leaf module. */\n  snippet?: {\n    lines: Array<string>\n    highlightLine: number\n    location: string\n  }\n}\n\n/**\n * Suggestion strings for server-only code leaking into client environments.\n * Used by both `formatViolation` (terminal) and runtime mock modules (browser).\n */\nexport const CLIENT_ENV_SUGGESTIONS = [\n  'Use createServerFn().handler(() => ...) to keep the logic on the server and call it from the client via an RPC bridge',\n  'Use createServerOnlyFn(() => ...) to mark it as server-only (it will throw if accidentally called from the client)',\n  'Use createIsomorphicFn().client(() => ...).server(() => ...) to provide separate client and server implementations',\n  'Move the server-only import out of this file into a separate .server.ts module that is not imported by any client code',\n] as const\n\n/**\n * Suggestion strings for client-only code leaking into server environments.\n * The JSX-specific suggestion is conditionally prepended by `formatViolation`.\n */\nexport const SERVER_ENV_SUGGESTIONS = [\n  'Use createClientOnlyFn(() => ...) to mark it as client-only (returns undefined on the server)',\n  'Use createIsomorphicFn().client(() => ...).server(() => ...) to provide separate client and server implementations',\n  'Move the client-only import out of this file into a separate .client.ts module that is not imported by any server code',\n] as const\n\nexport function formatViolation(info: ViolationInfo, root: string): string {\n  const rel = (p: string) => relativizePath(p, root)\n\n  const relLoc = (p: string, loc?: Loc) => {\n    const r = rel(p)\n    const file = loc?.file ? rel(loc.file) : r\n    return loc ? `${file}:${loc.line}:${loc.column}` : r\n  }\n\n  const relTraceStep = (step: TraceStep): string => {\n    const file = rel(step.file)\n    if (step.line == null) return file\n    const col = step.column ?? 1\n    return `${file}:${step.line}:${col}`\n  }\n\n  const lines: Array<string> = []\n  lines.push(``)\n  lines.push(`[import-protection] Import denied in ${info.envType} environment`)\n  lines.push(``)\n\n  if (info.type === 'specifier') {\n    lines.push(`  Denied by specifier pattern: ${String(info.pattern)}`)\n  } else if (info.type === 'file') {\n    lines.push(`  Denied by file pattern: ${String(info.pattern)}`)\n  } else {\n    lines.push(\n      `  Denied by marker: module is restricted to the opposite environment`,\n    )\n  }\n\n  lines.push(`  Importer: ${relLoc(info.importer, info.importerLoc)}`)\n  lines.push(`  Import: \"${rel(info.specifier)}\"`)\n  if (info.resolved) {\n    lines.push(`  Resolved: ${rel(info.resolved)}`)\n  }\n\n  if (info.trace.length > 0) {\n    lines.push(``)\n    lines.push(`  Trace:`)\n    for (let i = 0; i < info.trace.length; i++) {\n      const step = info.trace[i]!\n      const isEntry = i === 0\n      const tag = isEntry ? ' (entry)' : ''\n      const spec = step.specifier ? ` (import \"${rel(step.specifier)}\")` : ''\n      lines.push(`    ${i + 1}. ${relTraceStep(step)}${tag}${spec}`)\n    }\n  }\n\n  if (info.snippet) {\n    lines.push(``)\n    lines.push(`  Code:`)\n    for (const snippetLine of info.snippet.lines) {\n      lines.push(snippetLine)\n    }\n    lines.push(``)\n    lines.push(`  ${rel(info.snippet.location)}`)\n  }\n\n  lines.push(``)\n\n  // Add suggestions\n  if (info.envType === 'client') {\n    lines.push(`  Suggestions:`)\n    for (const s of CLIENT_ENV_SUGGESTIONS) {\n      lines.push(`    - ${s}`)\n    }\n  } else {\n    const snippetText = info.snippet?.lines.join('\\n') ?? ''\n    const looksLikeJsx =\n      /<[A-Z]/.test(snippetText) ||\n      (/\\{.*\\(.*\\).*\\}/.test(snippetText) && /</.test(snippetText))\n\n    lines.push(`  Suggestions:`)\n    if (looksLikeJsx) {\n      lines.push(\n        `    - Wrap the JSX in <ClientOnly fallback={<Loading />}>...</ClientOnly> so it only renders in the browser after hydration`,\n      )\n    }\n    for (const s of SERVER_ENV_SUGGESTIONS) {\n      lines.push(`    - ${s}`)\n    }\n  }\n\n  lines.push(``)\n  return lines.join('\\n')\n}\n"],"names":[],"mappings":"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"}