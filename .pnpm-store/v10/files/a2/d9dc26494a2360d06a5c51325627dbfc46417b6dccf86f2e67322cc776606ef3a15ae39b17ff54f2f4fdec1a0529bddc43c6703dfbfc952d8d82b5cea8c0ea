{"version":3,"file":"postCompileUsage.js","sources":["../../../src/import-protection-plugin/postCompileUsage.ts"],"sourcesContent":["import babel from '@babel/core'\nimport * as t from '@babel/types'\nimport { parseAst } from '@tanstack/router-utils'\n\ntype UsagePos = { line: number; column0: number }\n\n/**\n * Given transformed code, returns the first \"meaningful\" usage position for an\n * import from `source` that survives compilation.\n *\n * \"Preferred\" positions (call, new, member-access) take priority over bare\n * identifier references. The returned column is 0-based (Babel loc semantics).\n */\nexport function findPostCompileUsagePos(\n  code: string,\n  source: string,\n): UsagePos | undefined {\n  const ast = parseAst({ code })\n\n  // Collect local names bound from this specifier\n  const imported = new Set<string>()\n  for (const node of ast.program.body) {\n    if (t.isImportDeclaration(node) && node.source.value === source) {\n      if (node.importKind === 'type') continue\n      for (const s of node.specifiers) {\n        if (t.isImportSpecifier(s) && s.importKind === 'type') continue\n        imported.add(s.local.name)\n      }\n    }\n  }\n  if (imported.size === 0) return undefined\n\n  let preferred: UsagePos | undefined\n  let anyUsage: UsagePos | undefined\n\n  // babel.traverse can throw on malformed scopes (e.g. duplicate bindings from\n  // import + const re-declaration) because parseAst doesn't attach a hub\n  try {\n    babel.traverse(ast, {\n      ImportDeclaration(path) {\n        path.skip()\n      },\n\n      Identifier(path: babel.NodePath<t.Identifier>) {\n        if (preferred && anyUsage) {\n          path.stop()\n          return\n        }\n\n        const { node, parent, scope } = path\n        if (!imported.has(node.name)) return\n\n        // Skip binding positions (declarations, import specifiers, etc.)\n        if (path.isBindingIdentifier()) return\n\n        // Skip non-shorthand object property keys — they don't reference the import\n        if (\n          t.isObjectProperty(parent) &&\n          parent.key === node &&\n          !parent.computed &&\n          !parent.shorthand\n        )\n          return\n        if (t.isObjectMethod(parent) && parent.key === node && !parent.computed)\n          return\n        if (t.isExportSpecifier(parent) && parent.exported === node) return\n\n        // Skip if shadowed by a closer binding\n        const binding = scope.getBinding(node.name)\n        if (binding && binding.kind !== 'module') return\n\n        const loc = node.loc?.start\n        if (!loc) return\n        const pos: UsagePos = { line: loc.line, column0: loc.column }\n\n        const isPreferred =\n          (t.isCallExpression(parent) && parent.callee === node) ||\n          (t.isNewExpression(parent) && parent.callee === node) ||\n          (t.isMemberExpression(parent) && parent.object === node)\n\n        if (isPreferred) {\n          preferred ||= pos\n        } else {\n          anyUsage ||= pos\n        }\n      },\n    })\n  } catch {\n    // Scope analysis failed — cannot determine usage positions reliably\n    return undefined\n  }\n\n  return preferred ?? anyUsage\n}\n"],"names":[],"mappings":";;;AAaO,SAAS,wBACd,MACA,QACsB;AACtB,QAAM,MAAM,SAAS,EAAE,MAAM;AAG7B,QAAM,+BAAe,IAAA;AACrB,aAAW,QAAQ,IAAI,QAAQ,MAAM;AACnC,QAAI,EAAE,oBAAoB,IAAI,KAAK,KAAK,OAAO,UAAU,QAAQ;AAC/D,UAAI,KAAK,eAAe,OAAQ;AAChC,iBAAW,KAAK,KAAK,YAAY;AAC/B,YAAI,EAAE,kBAAkB,CAAC,KAAK,EAAE,eAAe,OAAQ;AACvD,iBAAS,IAAI,EAAE,MAAM,IAAI;AAAA,MAC3B;AAAA,IACF;AAAA,EACF;AACA,MAAI,SAAS,SAAS,EAAG,QAAO;AAEhC,MAAI;AACJ,MAAI;AAIJ,MAAI;AACF,UAAM,SAAS,KAAK;AAAA,MAClB,kBAAkB,MAAM;AACtB,aAAK,KAAA;AAAA,MACP;AAAA,MAEA,WAAW,MAAoC;AAC7C,YAAI,aAAa,UAAU;AACzB,eAAK,KAAA;AACL;AAAA,QACF;AAEA,cAAM,EAAE,MAAM,QAAQ,MAAA,IAAU;AAChC,YAAI,CAAC,SAAS,IAAI,KAAK,IAAI,EAAG;AAG9B,YAAI,KAAK,sBAAuB;AAGhC,YACE,EAAE,iBAAiB,MAAM,KACzB,OAAO,QAAQ,QACf,CAAC,OAAO,YACR,CAAC,OAAO;AAER;AACF,YAAI,EAAE,eAAe,MAAM,KAAK,OAAO,QAAQ,QAAQ,CAAC,OAAO;AAC7D;AACF,YAAI,EAAE,kBAAkB,MAAM,KAAK,OAAO,aAAa,KAAM;AAG7D,cAAM,UAAU,MAAM,WAAW,KAAK,IAAI;AAC1C,YAAI,WAAW,QAAQ,SAAS,SAAU;AAE1C,cAAM,MAAM,KAAK,KAAK;AACtB,YAAI,CAAC,IAAK;AACV,cAAM,MAAgB,EAAE,MAAM,IAAI,MAAM,SAAS,IAAI,OAAA;AAErD,cAAM,cACH,EAAE,iBAAiB,MAAM,KAAK,OAAO,WAAW,QAChD,EAAE,gBAAgB,MAAM,KAAK,OAAO,WAAW,QAC/C,EAAE,mBAAmB,MAAM,KAAK,OAAO,WAAW;AAErD,YAAI,aAAa;AACf,wBAAc;AAAA,QAChB,OAAO;AACL,uBAAa;AAAA,QACf;AAAA,MACF;AAAA,IAAA,CACD;AAAA,EACH,QAAQ;AAEN,WAAO;AAAA,EACT;AAEA,SAAO,aAAa;AACtB;"}